<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nilea — App</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#fff; --text:#111318; --muted:#5a6372; --border:#e7e9ee;
      --accent:#2F6F6D; --accentHover:#265b59;
      --radius:14px;
      --max:720px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .wrap{max-width:var(--max); margin:44px auto; padding:0 18px;}
    @media (max-width:420px){ .wrap{margin:28px auto; padding:0 16px;} }

    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;}
    .brand{font-weight:600; letter-spacing:-0.01em;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#fff; color:var(--text); cursor:pointer; text-decoration:none;
    }
    .btnPrimary{border-color:var(--accent); background:var(--accent); color:#fff;}
    .btnPrimary:hover{background:var(--accentHover); border-color:var(--accentHover);}
    .btn[disabled]{opacity:.6; cursor:not-allowed;}

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      background:#fff;
    }
    h1{margin:0 0 10px; font-size:26px; letter-spacing:-0.02em; line-height:1.2;}
    h2{margin:18px 0 8px; font-size:16px; letter-spacing:-0.01em;}
    p{margin:0 0 12px; color:var(--muted);}
    label{display:block; margin:0 0 6px; color:var(--muted); font-size:14px;}
    input{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      font:inherit;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .meta{margin:8px 0 14px; font-size:13px; color:var(--muted);}
    .hidden{display:none;}

    .divider{height:1px; background:var(--border); margin:16px 0;}
    .placeholder{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
      color:var(--muted);
      background:#fafbfc;
    }

    /* Typeform iframe */
    .tfWrap{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .tfFrame{
      width:100%;
      height:72vh;
      min-height:520px;
      border:0;
      display:block;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="topbar">
      <div class="brand">Nilea</div>
      <button id="logoutBtn" class="btn hidden" type="button">Log out</button>
    </div>

    <div id="statusTop" class="meta"></div>

    <!-- SAFE DEFAULT: logged-out view is visible by default -->
    <section id="loggedOut" class="card">
      <h1>Sign in</h1>
      <p>Enter your email — we’ll send a magic link.</p>

      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />

      <div class="row">
        <button id="sendLinkBtn" class="btn btnPrimary" type="button">Send sign-in link</button>
      </div>
    </section>

    <!-- Logged in view -->
    <section id="loggedIn" class="card hidden">
      <h1 id="welcomeTitle">Welcome</h1>
      <p id="welcomeSub">This is your Nilea space.</p>

      <!-- Primary action -->
      <div class="row">
        <button id="intakeBtn" class="btn btnPrimary" type="button">Start check</button>
      </div>

      <!-- After completed intake -->
      <div id="intakeStatus" class="meta"></div>

      <div id="postIntakeArea" class="hidden">
        <div class="divider"></div>

        <h2>Subscriber cards</h2>
        <div class="placeholder">Cards will appear here once we build the next layer.</div>

        <h2>Messages</h2>
        <div class="placeholder">Later: paste messages here to attach them to a person.</div>
      </div>

      <!-- Embedded Typeform (hidden until user clicks) -->
      <div id="embedArea" class="hidden">
        <div class="divider"></div>
        <h2>Quick check</h2>
        <p class="meta" style="margin-top:0">Answer a few questions. You can come back and add more anytime.</p>

        <div class="tfWrap">
          <iframe id="tfFrame" class="tfFrame" title="Nilea intake"></iframe>
        </div>

        <div class="row">
          <button id="closeEmbedBtn" class="btn" type="button">Close</button>
        </div>
      </div>
    </section>

    <noscript>
      <p class="meta">JavaScript is required to sign in.</p>
    </noscript>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ✅ Replace these:
    const SUPABASE_URL = "https://zcpwbllgsgeoenwarqop.supabase.co/";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjcHdibGxnc2dlb2Vud2FycW9wIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzgxOTQyOSwiZXhwIjoyMDgzMzk1NDI5fQ.woEPnBvD9rvXI71-TwSB2i0_JcWS_JgETwL20EhIBnw";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ✅ Typeform form id (your existing one)
    const TYPEFORM_FORM_ID = "hiAkhwEE";

    // ✅ Redirect back here from Typeform ending button:
    // Set in Typeform Ending: https://nilea.io/app/?intake=done
    const INTAKE_DONE_PARAM = "intake"; // intake=done

    const els = {
      loggedOut: document.getElementById("loggedOut"),
      loggedIn: document.getElementById("loggedIn"),
      logoutBtn: document.getElementById("logoutBtn"),
      email: document.getElementById("email"),
      sendLinkBtn: document.getElementById("sendLinkBtn"),
      welcomeTitle: document.getElementById("welcomeTitle"),
      welcomeSub: document.getElementById("welcomeSub"),
      statusTop: document.getElementById("statusTop"),

      intakeBtn: document.getElementById("intakeBtn"),
      intakeStatus: document.getElementById("intakeStatus"),
      postIntakeArea: document.getElementById("postIntakeArea"),

      embedArea: document.getElementById("embedArea"),
      tfFrame: document.getElementById("tfFrame"),
      closeEmbedBtn: document.getElementById("closeEmbedBtn"),
    };

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setStatus(msg=""){ els.statusTop.textContent = msg; }

    function usernameFromUser(user) {
      const email = user?.email || "";
      const local = email.includes("@") ? email.split("@")[0] : email;
      const metaName = user?.user_metadata?.name;
      return (metaName && String(metaName).trim()) || local || "there";
    }

    async function exchangeCodeIfPresent() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (!code) return;

      const { error } = await supabase.auth.exchangeCodeForSession(code);

      url.searchParams.delete("code");
      window.history.replaceState({}, document.title, url.toString());

      if (error) {
        console.error(error);
        setStatus("Sign-in failed. Please try again.");
      }
    }

    async function getLatestSubmission(userId) {
      // intake_submissions: user_id, typeform_response_id, submitted_at, payload
      const { data, error } = await supabase
        .from("intake_submissions")
        .select("typeform_response_id, submitted_at")
        .eq("user_id", userId)
        .order("submitted_at", { ascending: false })
        .limit(1);

      if (error) {
        console.error("getLatestSubmission error", error);
        return null;
      }
      return (data && data[0]) ? data[0] : null;
    }

    function openEmbedWithUser(userId) {
      // Hidden fields in Typeform: user_id=<uuid>
      const src = `https://form.typeform.com/to/${TYPEFORM_FORM_ID}?user_id=${encodeURIComponent(userId)}&typeform-medium=embed-snippet`;
      els.tfFrame.src = src;
      show(els.embedArea);
      // keep focus: scroll to embed
      els.embedArea.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function closeEmbed() {
      hide(els.embedArea);
      // optional: stop loading / free memory
      els.tfFrame.src = "about:blank";
    }

    function setIntakeUI({ hasCompleted }) {
      if (hasCompleted) {
        els.intakeBtn.textContent = "Add more";
        els.intakeStatus.textContent = "Saved. You can add more names anytime.";
        show(els.postIntakeArea);
      } else {
        els.intakeBtn.textContent = "Start check";
        els.intakeStatus.textContent = "";
        hide(els.postIntakeArea);
      }
    }

    async function reconcileAfterRedirectIfNeeded(userId) {
      // If user came back from Typeform ending: /app/?intake=done
      const url = new URL(window.location.href);
      const intakeDone = url.searchParams.get(INTAKE_DONE_PARAM) === "done";
      if (!intakeDone) return;

      // Remove param to avoid repeated behavior on refresh
      url.searchParams.delete(INTAKE_DONE_PARAM);
      window.history.replaceState({}, document.title, url.toString());

      // Webhook insert may be slightly delayed — poll briefly.
      els.intakeStatus.textContent = "Saving…";
      for (let i = 0; i < 6; i++) {
        const latest = await getLatestSubmission(userId);
        if (latest?.typeform_response_id) {
          setIntakeUI({ hasCompleted: true });
          return;
        }
        await new Promise(r => setTimeout(r, 700));
      }
      // If still not present, we just fall back to normal check later.
      els.intakeStatus.textContent = "Saved. (If you don’t see updates yet, refresh once.)";
    }

    async function render() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session?.user) {
        hide(els.loggedIn);
        hide(els.logoutBtn);
        show(els.loggedOut);
        return;
      }

      const user = session.user;
      const name = usernameFromUser(user);
      const userId = user.id;

      els.welcomeTitle.textContent = `Welcome to your Nilea, ${name}`;
      els.welcomeSub.textContent = "This is your private workspace.";
      hide(els.loggedOut);
      show(els.loggedIn);
      show(els.logoutBtn);

      // Determine completed vs not completed based on presence of a submission
      const latest = await getLatestSubmission(userId);
      const hasCompleted = !!latest?.typeform_response_id;
      setIntakeUI({ hasCompleted });

      // If we returned from Typeform ending, reconcile (poll for insert)
      await reconcileAfterRedirectIfNeeded(userId);

      // Wire button each render (idempotent)
      els.intakeBtn.onclick = () => openEmbedWithUser(userId);
    }

    async function hardResetToLoggedOut() {
      hide(els.loggedIn);
      hide(els.logoutBtn);
      show(els.loggedOut);
      els.logoutBtn.disabled = false;
      els.logoutBtn.textContent = "Log out";
      setStatus("");
      closeEmbed();
    }

    // Send magic link
    els.sendLinkBtn.addEventListener("click", async () => {
      const email = (els.email.value || "").trim();
      setStatus("");
      if (!email) { setStatus("Please enter your email."); return; }

      els.sendLinkBtn.disabled = true;
      els.sendLinkBtn.textContent = "Sending…";

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: `${window.location.origin}/app/` }
      });

      els.sendLinkBtn.disabled = false;
      els.sendLinkBtn.textContent = "Send sign-in link";

      if (error) {
        console.error(error);
        setStatus("Couldn’t send link. Please try again.");
        return;
      }
      setStatus("Check your email for the sign-in link.");
    });

    // Close embed
    els.closeEmbedBtn.addEventListener("click", () => {
      closeEmbed();
    });

    // Logout (deterministic)
    els.logoutBtn.addEventListener("click", async () => {
      setStatus("");
      els.logoutBtn.disabled = true;
      els.logoutBtn.textContent = "Logging out…";

      const fallback = setTimeout(() => {
        hardResetToLoggedOut();
      }, 1200);

      try {
        const { error } = await supabase.auth.signOut({ scope: "local" });
        if (error) {
          console.error(error);
          setStatus("Couldn’t log out. Please refresh and try again.");
          return;
        }
        await hardResetToLoggedOut();
      } finally {
        clearTimeout(fallback);
      }
    });

    // Boot
    try {
      await exchangeCodeIfPresent();
      await render();

      supabase.auth.onAuthStateChange(() => {
        render().catch(() => hardResetToLoggedOut());
      });
    } catch (e) {
      console.error(e);
      setStatus("App error. Please refresh.");
      await hardResetToLoggedOut();
    }
  </script>
</body>
</html>
