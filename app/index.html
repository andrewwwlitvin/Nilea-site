<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nilea — App</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#fff; --text:#111318; --muted:#5a6372; --border:#e7e9ee;
      --accent:#2F6F6D; --accentHover:#265b59;
      --radius:14px;
      --max:720px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .wrap{max-width:var(--max); margin:44px auto; padding:0 18px;}
    @media (max-width:420px){ .wrap{margin:28px auto; padding:0 16px;} }

    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;}
    .brand{font-weight:600; letter-spacing:-0.01em;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#fff; color:var(--text); cursor:pointer; text-decoration:none;
    }
    .btnPrimary{border-color:var(--accent); background:var(--accent); color:#fff;}
    .btnPrimary:hover{background:var(--accentHover); border-color:var(--accentHover);}
    .btn[disabled]{opacity:.6; cursor:not-allowed;}

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      background:#fff;
    }
    .stack{display:flex; flex-direction:column; gap:12px;}
    h1{margin:0 0 10px; font-size:26px; letter-spacing:-0.02em; line-height:1.2;}
    h2{margin:0 0 8px; font-size:16px; letter-spacing:-0.01em;}
    p{margin:0 0 12px; color:var(--muted);}
    label{display:block; margin:0 0 6px; color:var(--muted); font-size:14px;}
    input{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      font:inherit;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .meta{margin:8px 0 14px; font-size:13px; color:var(--muted);}
    .hidden{display:none;}
    .embedWrap{border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; background:#fff;}
    iframe{display:block; width:100%; height:720px; border:0;}
    .divider{height:1px; background:var(--border); margin:10px 0;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      font-size:13px; color:var(--muted);
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="topbar">
      <div class="brand">Nilea</div>
      <button id="logoutBtn" class="btn hidden" type="button">Log out</button>
    </div>

    <div id="statusTop" class="meta"></div>

    <!-- Logged-out view -->
    <section id="loggedOut" class="card">
      <h1>Sign in</h1>
      <p>Enter your email — we'll send a magic link.</p>

      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />

      <div class="row">
        <button id="sendLinkBtn" class="btn btnPrimary" type="button">Send sign-in link</button>
      </div>
    </section>

    <!-- Logged-in view -->
    <section id="loggedIn" class="hidden">
      <div class="stack">

        <section class="card">
          <h1 id="welcomeTitle">Welcome</h1>
          <p id="welcomeSub">This is your Nilea space.</p>

          <div class="row">
            <button id="openIntakeBtn" class="btn btnPrimary" type="button">Start intake</button>
            <button id="closeIntakeBtn" class="btn hidden" type="button">Close</button>
          </div>

          <div class="divider"></div>

          <div id="intakeState" class="pill hidden"></div>
          <div id="intakeHint" class="meta"></div>
        </section>

        <!-- Embedded Typeform (hidden by default; opened by button) -->
        <section id="embedSection" class="embedWrap hidden">
          <iframe id="typeformFrame" title="Nilea intake"></iframe>
        </section>

        <!-- Placeholders -->
        <section class="card">
          <h2>Subscriber cards</h2>
          <p class="meta">Placeholder — cards will appear here after intake processing.</p>
        </section>

        <section class="card">
          <h2>Paste DMs</h2>
          <p class="meta">Placeholder — DM intake will live here in a later build.</p>
        </section>

      </div>
    </section>

    <noscript>
      <p class="meta">JavaScript is required to sign in.</p>
    </noscript>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ✅ Replace these:
    const SUPABASE_URL = "https://zcpwbllgsgeoenwarqop.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjcHdibGxnc2dlb2Vud2FycW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MTk0MjksImV4cCI6MjA4MzM5NTQyOX0.aPZRvUOAy4fDUKHj79GqBmo_wvlQBv0p2it9gff6xdA";

    // ✅ Replace with your Typeform embed URL (without user_id parameter - it's added automatically)
    // Example: "https://form.typeform.com/to/hiAkhwEE"
    const TYPEFORM_EMBED_URL = "https://form.typeform.com/to/hiAkhwEE";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const els = {
      loggedOut: document.getElementById("loggedOut"),
      loggedIn: document.getElementById("loggedIn"),
      logoutBtn: document.getElementById("logoutBtn"),
      email: document.getElementById("email"),
      sendLinkBtn: document.getElementById("sendLinkBtn"),
      welcomeTitle: document.getElementById("welcomeTitle"),
      welcomeSub: document.getElementById("welcomeSub"),
      statusTop: document.getElementById("statusTop"),

      openIntakeBtn: document.getElementById("openIntakeBtn"),
      closeIntakeBtn: document.getElementById("closeIntakeBtn"),
      embedSection: document.getElementById("embedSection"),
      typeformFrame: document.getElementById("typeformFrame"),

      intakeState: document.getElementById("intakeState"),
      intakeHint: document.getElementById("intakeHint"),
    };

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setStatus(msg=""){ els.statusTop.textContent = msg; }

    function usernameFromUser(user) {
      const email = user?.email || "";
      const local = email.includes("@") ? email.split("@")[0] : email;
      const metaName = user?.user_metadata?.name;
      return (metaName && String(metaName).trim()) || local || "there";
    }

    async function exchangeCodeIfPresent() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (!code) return;

      const { error } = await supabase.auth.exchangeCodeForSession(code);

      // Clean URL to avoid re-exchange on refresh
      url.searchParams.delete("code");
      window.history.replaceState({}, document.title, url.toString());

      if (error) {
        console.error(error);
        setStatus("Sign-in failed. Please try again.");
      }
    }

    async function hardResetToLoggedOut() {
      hide(els.loggedIn);
      hide(els.logoutBtn);
      show(els.loggedOut);

      // reset embed ui
      hide(els.embedSection);
      hide(els.closeIntakeBtn);
      show(els.openIntakeBtn);
      els.openIntakeBtn.disabled = false;
      els.openIntakeBtn.textContent = "Start intake";
      els.closeIntakeBtn.textContent = "Close";
      els.typeformFrame.src = "about:blank";

      hide(els.intakeState);
      els.intakeState.textContent = "";
      els.intakeHint.textContent = "";

      els.logoutBtn.disabled = false;
      els.logoutBtn.textContent = "Log out";
      setStatus("");
    }

    function buildTypeformUrl(userId) {
      const base = TYPEFORM_EMBED_URL.trim();
      if (!base) return "";
      const hasQ = base.includes("?");
      const sep = hasQ ? "&" : "?";
      return `${base}${sep}user_id=${encodeURIComponent(userId)}`;
    }

    async function getIntakeCompleted(userId) {
      // Requires RLS SELECT policy allowing user to read their own rows
      // Table: intake_submissions, columns: user_id, created_at
      const { data, error } = await supabase
        .from("intake_submissions")
        .select("id, created_at")
        .eq("user_id", userId)
        .order("created_at", { ascending: false })
        .limit(1);

      if (error) {
        console.error("intake_submissions select error:", error);
        // Fail closed: don't break UI
        return { completed: false, lastCreatedAt: null };
      }

      const row = data?.[0] || null;
      return { completed: !!row, lastCreatedAt: row?.created_at || null };
    }

    async function render() {
      // ✅ IMPORTANT: validate session (kills stale cached session)
      const { data: userData, error: userErr } = await supabase.auth.getUser();

      if (userErr || !userData?.user) {
        await hardResetToLoggedOut();
        return;
      }

      const user = userData.user;
      const name = usernameFromUser(user);

      els.welcomeTitle.textContent = `Welcome to your Nilea, ${name}`;
      els.welcomeSub.textContent = `You're signed in as ${user.email || ""}`.trim();

      hide(els.loggedOut);
      show(els.loggedIn);
      show(els.logoutBtn);

      // Button state based on "completed submission exists"
      const { completed, lastCreatedAt } = await getIntakeCompleted(user.id);

      show(els.intakeState);
      if (!completed) {
        els.intakeState.textContent = "Intake not submitted yet";
        els.intakeHint.textContent = "When you finish the intake, refresh this page to see your updated status.";
        els.openIntakeBtn.textContent = "Start intake";
      } else {
        els.intakeState.textContent = "Intake received";
        els.intakeHint.textContent =
          `Last submission: ${new Date(lastCreatedAt).toISOString().slice(0, 19).replace("T"," ")} UTC. Refresh after a new submission.`;
        els.openIntakeBtn.textContent = "Add more";
      }

      // Keep embed closed by default after login/refresh
      hide(els.embedSection);
      hide(els.closeIntakeBtn);
      show(els.openIntakeBtn);
      els.typeformFrame.src = "about:blank";
    }

    // Send magic link
    els.sendLinkBtn.addEventListener("click", async () => {
      const email = (els.email.value || "").trim();
      setStatus("");
      if (!email) { setStatus("Please enter your email."); return; }

      els.sendLinkBtn.disabled = true;
      els.sendLinkBtn.textContent = "Sending…";

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { 
          emailRedirectTo: window.location.href.split('?')[0] // Current page without query params
        }
      });

      els.sendLinkBtn.disabled = false;
      els.sendLinkBtn.textContent = "Send sign-in link";

      if (error) {
        console.error(error);
        setStatus("Couldn't send link. Please try again.");
        return;
      }
      setStatus("Check your email for the sign-in link.");
    });

    // Open intake embed (in-cabinet)
    els.openIntakeBtn.addEventListener("click", async () => {
      setStatus("");
      els.openIntakeBtn.disabled = true;
      els.openIntakeBtn.textContent = "Opening…";

      const { data: userData } = await supabase.auth.getUser();
      const user = userData?.user;

      if (!user) {
        await hardResetToLoggedOut();
        return;
      }

      const url = buildTypeformUrl(user.id);
      if (!url) {
        setStatus("Missing TYPEFORM_EMBED_URL in code.");
        els.openIntakeBtn.disabled = false;
        els.openIntakeBtn.textContent = "Start intake";
        return;
      }

      els.typeformFrame.src = url;
      show(els.embedSection);
      show(els.closeIntakeBtn);
      els.openIntakeBtn.disabled = false;
      // Text stays as Start/Add more (set by render)
    });

    els.closeIntakeBtn.addEventListener("click", () => {
      hide(els.embedSection);
      hide(els.closeIntakeBtn);
      els.typeformFrame.src = "about:blank";
    });

    // Logout (deterministic)
    els.logoutBtn.addEventListener("click", async () => {
      setStatus("");
      els.logoutBtn.disabled = true;
      els.logoutBtn.textContent = "Logging out…";

      const fallback = setTimeout(() => {
        hardResetToLoggedOut();
      }, 1200);

      try {
        const { error } = await supabase.auth.signOut({ scope: "local" });
        if (error) {
          console.error(error);
          setStatus("Couldn't log out. Please refresh and try again.");
          return;
        }
        await hardResetToLoggedOut();
      } finally {
        clearTimeout(fallback);
      }
    });

    // Boot with strong error handling: never allow "blank" state
    try {
      await exchangeCodeIfPresent();
      await render();

      supabase.auth.onAuthStateChange(() => {
        render().catch(() => hardResetToLoggedOut());
      });
    } catch (e) {
      console.error(e);
      setStatus("App error. Please refresh.");
      await hardResetToLoggedOut();
    }
  </script>
</body>
</html>
